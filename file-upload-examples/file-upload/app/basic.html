<!doctype html>
<html lang="en" ng-app="APP">
<head>
  <meta charset="UTF-8">
  <title>angular file upload</title>
</head>
<body>
  <form ng-controller="uploader">
    <input type="file" file-input="files" multiple />
    <button ng-click="upload()">Upload</button>

    <hr>
    files to upload
    <li ng-repeat="file in files">{{file.name}}</li>

    <hr>
    files uploaded
    <li ng-repeat="file in uploaded">{{file.name}}</li>
  </form>


  <script src="/lib/angular.js"></script>
  <script>
  var app = angular.module('APP', []);
  // stores a list of uploaded files.
  app.value('store', {
    uploaded : []
  });

  app.directive('fileInput',['$parse',function($parse){
    return {
      restrict:'A',
      link:function(scope,elm,attrs){
        elm.bind('change',function(){
          $parse(attrs.fileInput).assign(scope,elm[0].files);
          scope.$apply();
        })
      }
    }
  }]);

  app.controller('uploader', ['$scope', '$http', 'store',
    function($scope, $http, store) {

      $scope.upload = function() {
        var fd = new FormData();

        angular.forEach($scope.files,function(file){
          fd.append('file',file)
        });

        $http.post('/upload', fd, {
          transformRequest:angular.identity,
          headers:{'Content-Type':undefined}
        })
        .success(function(files) {
          store.uploaded = store.uploaded.concat(files);
          $scope.uploaded = store.uploaded;
        })
      }
    }
    ])
  </script>
</body>
</html>
